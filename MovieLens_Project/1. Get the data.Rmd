---
title: "Get the data"
author: "Trần Phú Hòa"
date: "March 1, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Contents
1. Load necessary packages
2. Download, unzip and load MovieLens data
3. Validation set will be 10% of MovieLens data
4. Make sure userId and movieId in validation set are also in edx set
5. Add rows removed from validation set back into edx set
6. Save data to .RDS

# 1. Load necessary packages

```{r Necessary packages, echo = FALSE}
if(!require(tidyverse)) install.packages("tidyverse", repos = "http://cran.us.r-project.org")
if(!require(caret)) install.packages("caret", repos = "http://cran.us.r-project.org")
if(!require(lubridate)) install.packages("lubridate", repos = "http://cran.us.r-project.org")
```


# 2. Download, unzip and load MovieLens data
* Download and unzip the MovieLens data from its web was done by HardvardX and those codes are in "ImportMovieLens_Web.R".
* Lessons that I learn from those codes are:
** How to download a data file on website using "download.file()"
** How to read a dat file in a zip format using "read.table()", "unzip()", "readLines()", "gsub()"


```{r}
# MovieLens 10M dataset:
# https://grouplens.org/datasets/movielens/10m/
# http://files.grouplens.org/datasets/movielens/ml-10m.zip

dl <- tempfile()
download.file("http://files.grouplens.org/datasets/movielens/ml-10m.zip", dl)

ratings <- read.table(text = gsub("::", "\t", readLines(unzip(dl, "ml-10M100K/ratings.dat"))),
                      col.names = c("userId", "movieId", "rating", "timestamp"))

movies <- str_split_fixed(readLines(unzip(dl, "ml-10M100K/movies.dat")), "\\::", 3)

colnames(movies) <- c("movieId", "title", "genres")

movies <- as.data.frame(movies) %>% mutate(movieId = as.numeric(levels(movieId))[movieId],
                                           title = as.character(title),
                                           genres = as.character(genres))

movielens <- left_join(ratings, movies, by = "movieId")
```

# 3. Validation set will be 10% of MovieLens data
```{r Validation set, echo = FALSE}
set.seed(1)
test_index <- createDataPartition(y = movielens$rating, times = 1, p = 0.1, list = FALSE)
edx <- movielens[-test_index,]
temp <- movielens[test_index,]
```

# 4. Make sure userId and movieId in validation set are also in edx set
```{r Check, echo = FALSE}
validation <- temp %>% 
  semi_join(edx, by = "movieId") %>%
  semi_join(edx, by = "userId")
```

# 5. Add rows removed from validation set back into edx set
```{r, echo = FALSE}
removed <- anti_join(temp, validation)
edx <- rbind(edx, removed)
rm(dl, ratings, movies, test_index, temp, movielens, removed)
```

# 6. Save data to .RDS

```{r}
save(edx, validation, file = "MediaLens_data.RData")
```

