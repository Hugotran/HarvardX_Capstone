---
title: "2. Create sets and tidy up datas"
author: "Trần Phú Hòa"
date: "March 14, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Contents
Clear workspace and free up memory
Load useful packages into R
Load edx data
Create a file named "tidy_data.RData" that content tidy versions of "edx" and "validate" including "edx1", "tidy_edx" and "validate_tidy_edx"

# Clear workspace and free up memory
```{r Clear workspace and free up memory, echo = FALSE}
rm(list = ls(all.names =  TRUE))
gc()
```

## Load useful packages into R
```{r Necessary packages, echo = FALSE}
if(!require(tidyverse)) install.packages("tidyverse", repos = "http://cran.us.r-project.org")
if(!require(lubridate)) install.packages("lubridate", repos = "http://cran.us.r-project.org")

#to create training, testing and validation splits
if(!require(rsample)) install.packages("rsample", repos = "http://cran.us.r-project.org") 
```

## Load edx data
```{r}
#Load edx data from my workspace "HarvardX_Capstone_MovieLens"
load("C:/Tran Phu Hoa workspace/1. Current/HarvardX_Capstone_MovieLens_/MediaLens_data.RData")
```

## Create a tidy version of edx data called "tidy_edx"
* Do we need to wrangle this data? (Wide and Tidy definition)
* Yes, we do. We have three steps to do:
** 1. Separate variables in the "genres" column
** 2. Mutate "date" using the "timestamp" column
** 3. Mutate "released_year" using "title" column

```{r Create tidy_edx data, echo = FALSE}
#Separate variables in "genres", and put them into "genres" column gain
tidy_edx_sep_genres <- edx %>% separate_rows(genres, sep = "\\|")

#Parse date to "timestamp" variable
tidy_edx_date <- tidy_edx_sep_genres %>% mutate(date_of_rating = as_datetime(timestamp)) %>%
  select(c("userId", "movieId", "rating", "title", "genres", "date_of_rating"))
```

```{r}
#Select object "year" in the "title" column, and create "movie_year" variable
#Detect "year" in the title column
tidy_edx <- tidy_edx_date %>% 
  mutate(movie_year = str_extract(tidy_edx_date$title, regex("\\(\\d{4}\\)"))) 

tidy_edx <- tidy_edx %>%
  mutate(movie_year = str_extract(tidy_edx$movie_year, regex("\\d{4}")))

str(tidy_edx)
```

### Create edx_combinedgenres

```{r edx_combinedgenres, echo = FALSE}
edx1 <- edx %>% 
  mutate(date_of_rating = as_datetime(timestamp), 
         movie_year = str_extract(edx$title, regex("\\(\\d{4}\\)")))
edx1 <- edx1 %>%
  mutate(movie_year = str_extract(edx1$movie_year, regex("\\d{4}"))) %>%
  select(c("userId", "movieId", "rating", "title", "genres", "date_of_rating", "movie_year"))
  
```

### Create validate_tidy_edx
```{r Validate_tidy_edx, echo = FALSE}
validate_tidy_edx_sep_genres <- validation %>% separate_rows(genres, sep = "\\|")
```

```{r}
#Parse date to "timestamp" variable
validate_tidy_edx_date <- validate_tidy_edx_sep_genres %>% mutate(date_of_rating = as_datetime(timestamp)) %>%
  select(c("userId", "movieId", "rating", "title", "genres", "date_of_rating"))

#Select object "year" in the "title" column, and create "movie_year" variable
#Detect "year" in the title column
validate_tidy_edx <- validate_tidy_edx_date %>% 
  mutate(movie_year = str_extract(validate_tidy_edx_date$title, regex("\\(\\d{4}\\)")))
validate_tidy_edx <- validate_tidy_edx %>%
  mutate(movie_year = str_extract(validate_tidy_edx$movie_year, regex("\\d{4}")))
  

str(validate_tidy_edx)
```
## Save the data

```{r Save "tidy_edx"}
save(tidy_edx, file = "tidy_edx.RData")
```

```{r Save "validate_tidy_edx"}
save(validate_tidy_edx, file = "validate_tidy_edx.RData")
```

```{r Save "edx1"}
save(edx1, file = "edx1.RData")
```

