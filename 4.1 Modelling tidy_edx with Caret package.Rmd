---
title: "4.1 Modelling tidy_edx with Caret package"
author: "Trần Phú Hòa"
date: "March 19, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Content
Remove and free up space 
Load useful packages
Load useful data set (Note that I always want to remove those datasets that I will not use to save the memory.)
Remove unnecessary data
Create a random subset of my data (p will be changed many times)

Create training set
Create cross validation data set
Create linear regression model
Create Random forest model

# Remove and free up working space

```{r Remove and free up working space, echo = FALSE}
rm(list = ls(all.names = TRUE))
gc()
memory.limit()
memory.size()
```

# Load useful packages
```{r Load useful packages, echo = FALSE}
# Data manipulation and visualisation package
if(!require(tidyverse)) install.packages("tidyverse", repos = "http://cran.us.r-project.org")

# Machine learning package
if(!require(caret)) install.packages("caret", repos = "http://cran.us.r-project.org")
if(!require(randomForest)) install.packages("randomForest", repos = "http://cran.us.r-project.org")
if(!require(kernlab)) install.packages("kernlab", repos = "http://cran.us.r-project.org")
if(!require(ranger)) install.packages("ranger", repos = "http://cran.us.r-project.org")
if(!require(Metrics)) install.packages("Metrics", repos = "http://cran.us.r-project.org")
if(!require(Rborist)) install.packages("Rborist", repos = "http://cran.us.r-project.org")

# Timing the running time of codes
if(!require(tictoc)) install.packages("tictoc", repos = "http://cran.us.r-project.org")
```

```{r Memory size}
memory.size()
gc()
```

# Load useful data
```{r}
tic()

load("tidy_edx.RData")
glimpse(tidy_edx)
memory.size()

toc()
```

# Create sample of tidy_edx (p = 0.0001)
```{r}
set.seed(1)

tidy_edx_n_rating_higherequal1000 <- tidy_edx %>% group_by(userId) %>% mutate(count = n()) %>% filter(count >= 1000) %>% ungroup(userId)
str(tidy_edx_n_rating_higherequal1000)
```

```{r}
set.seed(2)
sample1 <-sample_n(tidy_edx, size = 0.01 * nrow(tidy_edx))
subset_sample1000 <- sample_n(tidy_edx_n_rating_higherequal1000, size = 0.001 * nrow(tidy_edx_n_rating_higherequal1000))
```

# Machine Learning with Caret
## Reports:
Algorithms got problem in Caret: naiveBayes, ranger, ANFIS, bagEarth, rf, nnet, treebag, bayesglm, brnn,bridge, kknn

```{r Modelling sample1 with Ranger}
tic()
model_ranging1 <- ranger(formula = rating ~.,
                     data = sample1,
                     mtry = 4, num.trees = 100, seed = 42)
test_actual <- sample1$rating
test_predict <- predict(model_ranging1, sample1)$predictions

rmse(test_actual, test_predict)
toc()
```


```{r Modelling tidy_edx_n_rating_higherequal1000 with Ranger}
tic()
sample2 <- sample_n(tidy_edx_n_rating_higherequal1000, size = nrow(tidy_edx_n_rating_higherequal1000) * 0.3)
model_ranging2 <- ranger(formula = rating ~.,
                     data = sample2,
                     mtry = 4, num.trees = 100, seed = 42)

test_actual <- sample2$rating
test_predict <- predict(model_ranging2, sample2)$predictions

rmse(test_actual, test_predict)
toc()
```

```{r Modelling sample1 with Ranger}
tic()
# Run random forest algorithm for rating with all variables excepted "userId" and "count"
model_ranging3 <- ranger(formula = rating ~ movieId + title + genres + date_of_rating + movie_year,
                     data = sample1,
                     mtry = 4, num.trees = 100, seed = 42)

test_actual3 <- sample1$rating
test_predict3 <- predict(model_ranging3, sample1)$predictions

rmse(test_actual3, test_predict3)
toc()
```

```{r Modelling sample1 with Ranger}
tic()
# Run random forest algorithm for rating with all variables excepted "userId" and "count" using subset of sample1
set.seed(111)

model_ranging3 <- ranger(formula = rating ~ movieId + title + genres + date_of_rating + movie_year,
                     data = subset_sample1000,
                     mtry = 4, num.trees = 100, seed = 42)

test_actual3 <- subset_sample1000$rating
test_predict3 <- predict(model_ranging3, subset_sample1000)$predictions

rmse(test_actual3, test_predict3)
toc()
```

```{r}
tic()

man_grid <- expand.grid(minNode = c(1,5),
                        predFixed = c(10, 15, 25, 35, 50, 100))

fitControl <- trainControl(method = "cv",
                           number = 5,
                           p = 0.8)

sample1_rborist <- train(rating ~ movieId + title + genres + date_of_rating + movie_year,
                    data = subset_sample1000,
                    method ="Rborist", 
                    trControl = fitControl,
                    verbose= FALSE,
                    tuneGrid = man_grid,
                    nSample = 5000)

summary(sample1_rborist)
toc()
```

```{r}

sample1_rborist <- train(rating ~ movieId + title + genres + date_of_rating + movie_year,
                    data = subset_sample1000,
                    method = "kknn")

```


```{r}
tic()

sample1_lm2 <- train(rating ~ movieId + genres + date_of_rating + movie_year,
                    data = sample_2,
                    method ="lm", 
                    trControl = trainControl(method = "boot"))

sample1_lm2
toc()
```

```{r}
tic()

sample1_glm <- train(rating ~ movieId + genres + date_of_rating + movie_year, data = subset_sample1000, method ="glm", trControl = trainControl("boot"))
sample1_glm

toc()
```


```{r}
tic()

sample1_glm2 <- train(rating ~ movieId + genres + date_of_rating + movie_year,
                    data = sample1,
                    method ="glm", 
                    trControl = trainControl(method = "repeatedcv",
                                             number = 6,
                                             repeats = 5
                                             ))

sample1_glm2
toc()
```



```{r}
tic()

sample1_kknn1 <- train(rating ~ movieId + genres + date_of_rating + movie_year,
                    data = sample_2,
                    method ="kknn")

sample1_kknn1
toc()
```


```{r}
# Define Cartesian grid
man_grid <- expand.grid(degree = c(1, 2), 
                        scale = c(0.1, 0.01), 
                        C = 0.5)

fitControl <- trainControl(method = "repeatedcv",
                           number = 2,
                           repeats = 3)

# Start timer, set seed & train model
tic()
set.seed(42)
svm_model_voters_grid <- train(rating ~ movieId + genres + movie_year + date_of_rating, 
                   data = sample1, 
                   method = "svmPoly", 
                   trControl = fitControl,
                   verbose= FALSE,
                   tuneGrid = man_grid)
toc()
```


```{r}
library("sparklyr", lib.loc="~/R/win-library/3.5")
sc <- spark_connect(master = "local")
ls("package:sparklyr", pattern = "^ml")



```


```{r}
sessionInfo()
```

